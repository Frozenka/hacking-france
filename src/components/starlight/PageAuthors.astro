---
import { Image } from 'astro:assets';

interface Props {
  repo: string;
  file: string;
}

const { repo, file } = Astro.props;

// Fichiers déplacés vers cybersecurite/ : l’historique Git reste sur l’ancien chemin.
// On interroge les deux chemins pour récupérer les auteurs.
function getLegacyPaths(currentFile: string): string[] {
  const prefix = 'cybersecurity/cybersecurite/';
  if (currentFile.startsWith(prefix)) {
    return ['cybersecurity/' + currentFile.slice(prefix.length)];
  }
  if (currentFile === 'articles/arp-cache-poisoning') {
    return [
      'cybersecurity/cybersecurite/offensive/arp_poisoning',
      'cybersecurity/offensive/arp_poisoning',
    ];
  }
  return [];
}

async function fetchCommitsForPath(path: string) {
  const url = new URL(`https://api.github.com/repos/${repo}/commits`);
  const fullPath = path.includes('.') ? `src/content/docs/${path}` : `src/content/docs/${path}.mdx`;
  url.searchParams.set('path', fullPath);
  url.searchParams.set('per_page', '100');

  const response = await fetch(url, {
    headers: {
      Accept: 'application/vnd.github+json',
      'User-Agent': 'starlight-contributors/1.0',
    },
  });

  const data = await response.json();
  return Array.isArray(data) ? data : [];
}

async function fetchCommits() {
  const current = await fetchCommitsForPath(file);
  const legacyPaths = getLegacyPaths(file);
  const bySha = new Map(current.map((c: { sha?: string }) => [c.sha, c]));
  for (const legacyPath of legacyPaths) {
    const legacy = await fetchCommitsForPath(legacyPath);
    for (const c of legacy) {
      if (c.sha && !bySha.has(c.sha)) bySha.set(c.sha, c);
    }
  }
  return Array.from(bySha.values());
}

function removeDuplicates(commits: { author?: { login: string; id: number } }[]) {
  if (!Array.isArray(commits)) return [];
  const map = new Map<number, { login: string; id: number }>();
  for (const commit of commits) {
    const author = commit?.author;
    if (author?.id != null && author?.login) {
      map.set(author.id, { login: author.login, id: author.id });
    }
  }
  return Array.from(map.values());
}

const commits = await fetchCommits();
const uniqueAuthors = removeDuplicates(commits);
---

<div class="page-authors">
  <p>Auteurs de la page</p>
  {uniqueAuthors.length > 0 ? (
    <ul class="smol-avatar-list not-content">
      {uniqueAuthors.map(({ login, id }) => (
        <li>
          <a href={`https://github.com/${login}`} title={login}>
            <Image alt={login} width="64" height="64" src={`https://avatars.githubusercontent.com/u/${id}`} />
          </a>
        </li>
      ))}
    </ul>
  ) : (
    <p class="page-authors-fallback">
      <a href={`https://github.com/${repo}/commits/main/src/content/docs/${file.includes('.') ? file : file + '.mdx'}`} target="_blank" rel="noopener noreferrer">
        Voir l'historique des contributeurs sur GitHub →
      </a>
    </p>
  )}
</div>

<style define:vars={{ 'avatar-count': Math.max(1, uniqueAuthors.length) }}>
.page-authors {
  display: flex;
  flex-direction: column;
  gap: 0.5em;
  font-size: var(--sl-text-sm);
  font-weight: 600;
}
.page-authors-fallback {
  margin: 0;
  font-weight: normal;
}
.page-authors-fallback a {
  color: var(--sl-color-accent);
  text-decoration: none;
}
.page-authors-fallback a:hover {
  text-decoration: underline;
}

.smol-avatar-list {
  --avatar-size: 2rem;
  display: grid;
  grid-template-columns: repeat(var(--avatar-count), max(44px, calc(var(--avatar-size) / 1.15)));
  padding: 0.08em;
  font-size: var(--avatar-size);
  list-style: none;
}

@media (any-hover: hover) and (any-pointer: fine) {
  .smol-avatar-list {
    grid-template-columns: repeat(calc(var(--avatar-count) + 1), calc(var(--avatar-size) / 1.75));
  }
}

.smol-avatar-list li {
  width: var(--avatar-size);
  height: var(--avatar-size);
}

.smol-avatar-list li:hover ~ li a,
.smol-avatar-list li:focus-within ~ li a {
  transform: translateX(33%);
}

.smol-avatar-list img,
.smol-avatar-list a {
  display: block;
  border-radius: 50%;
}

.smol-avatar-list a {
  transition: transform 180ms ease-in-out;
}

.smol-avatar-list img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  background-color: #fff;
  box-shadow: 0 0 0 0.05em #fff, 0 0 0 0.08em rgba(0, 0, 0, 0.15);
}

.smol-avatar-list a:focus {
  outline: 2px solid transparent;
  box-shadow: 0 0 0 0.08em #29344B, 0 0 0 0.12em white;
}
</style>