---
import { getCollection } from 'astro:content';

const allDocs = await getCollection('docs');

const excludeIds = ['index', '404', 'about', 'community/index', 'contribute/index', 'explorer'];
const excludePatterns = (id: string) =>
  !excludeIds.includes(id) && !id.endsWith('/Recherche');

const docs = allDocs.filter((e) => excludePatterns(e.id));

type Doc = (typeof allDocs)[number];

const CATEGORIES: { id: string; label: string; shortLabel: string; order: number; hint?: string }[] = [
  { id: 'articles', label: 'Articles', shortLabel: 'A', order: 0, hint: 'Tutoriels, certifications (OSCP, CPTS…), cheat sheet & outils' },
  { id: 'writeup', label: 'Writeups', shortLabel: 'W', order: 1, hint: 'Solutions de machines et challenges (HackTheBox, VulnLab, TryHackMe, GOAD…)' },
  { id: 'events', label: 'Événements', shortLabel: 'E', order: 2, hint: 'Talks, replays, CTF et événements de la communauté' },
  { id: 'cybersecurity', label: 'Parcours & guides', shortLabel: 'P', order: 3, hint: 'Guides et parcours d’apprentissage (offensive, défensif, CTF…)' },
  { id: 'misc', label: 'Ressources', shortLabel: 'R', order: 4, hint: 'Liens utiles : Discord, chaînes YouTube, Twitch…' },
];

const ARTICLES_SUBSECTIONS: { id: string; label: string }[] = [
  { id: 'articles', label: 'Tutoriels' },
  { id: 'certifications', label: 'Certifications' },
  { id: 'tools', label: 'Cheat sheet & outils' },
];

function getCategory(id: string): string {
  const top = id.split('/')[0];
  return top || 'misc';
}

function getSubLabel(id: string): string {
  if (id.startsWith('writeup/vulnlab')) return 'VulnLab';
  if (id.startsWith('writeup/hackthebox')) return 'HackTheBox';
  if (id.startsWith('writeup/tryHackme')) return 'TryHackMe';
  if (id.startsWith('writeup/GOAD')) return 'GOAD';
  if (id.startsWith('writeup/')) return 'Writeup';
  if (id.startsWith('events/talks')) return 'Talks';
  if (id.startsWith('events/ctf')) return 'CTF';
  return '';
}

const ARTICLE_CAT_IDS = new Set(ARTICLES_SUBSECTIONS.map((s) => s.id));
const VALID_CAT_IDS = new Set([
  ...CATEGORIES.map((c) => c.id),
  ...ARTICLE_CAT_IDS,
]);
const byCategory = new Map<string, Doc[]>();
for (const entry of docs) {
  const cat = getCategory(entry.id);
  if (!VALID_CAT_IDS.has(cat)) continue;
  if (!byCategory.has(cat)) byCategory.set(cat, []);
  byCategory.get(cat)!.push(entry);
}

for (const arr of byCategory.values()) {
  arr.sort((a, b) => a.data.title.localeCompare(b.data.title));
}

function getArticlesMergedCount() {
  return ARTICLES_SUBSECTIONS.reduce((sum, sub) => sum + (byCategory.get(sub.id) ?? []).length, 0);
}

const orderedCategories = [...CATEGORIES].sort((a, b) => a.order - b.order);
const totalArticles = docs.length;
const totalCategories = orderedCategories.filter((c) =>
  c.id === 'articles' ? getArticlesMergedCount() > 0 : (byCategory.get(c.id) ?? []).length > 0
).length;

const writeupItems = byCategory.get('writeup') ?? [];
const writeupByPlatform = new Map<string, Doc[]>();
for (const doc of writeupItems) {
  const platform = getSubLabel(doc.id) || 'Autres';
  if (!writeupByPlatform.has(platform)) writeupByPlatform.set(platform, []);
  writeupByPlatform.get(platform)!.push(doc);
}
---

<div class="explorer-page">
  <header class="explorer-header">
    <h1 class="explorer-title">Explorer le contenu</h1>
    <p class="explorer-tagline">
      Articles, writeups, guides et ressources par la communauté Hacking France.
    </p>
    <div class="explorer-stats" role="status" aria-live="polite">
      <span class="explorer-stat">
        <strong>{totalArticles}</strong> article{totalArticles > 1 ? 's' : ''}
      </span>
      <span class="explorer-stat-sep" aria-hidden="true">·</span>
      <span class="explorer-stat">
        <strong>{totalCategories}</strong> catégorie{totalCategories > 1 ? 's' : ''}
      </span>
    </div>
  </header>

  <nav class="explorer-nav" aria-label="Aller à une catégorie">
    {
      orderedCategories.map((cat) => {
        const count = cat.id === 'articles' ? getArticlesMergedCount() : (byCategory.get(cat.id) ?? []).length;
        if (count === 0) return null;
        return (
          <a class="explorer-nav-link" href={`#${cat.id}`}>
            <span class="explorer-nav-dot" aria-hidden="true" data-cat={cat.id} />
            <span class="explorer-nav-text">{cat.label}</span>
            <span class="explorer-nav-count">{count}</span>
          </a>
        );
      })
    }
  </nav>

  <main class="explorer-sections">
    {
      orderedCategories.map((cat) => {
        const items = byCategory.get(cat.id) ?? [];
        const count = cat.id === 'articles' ? getArticlesMergedCount() : items.length;
        if (count === 0) return null;
        const useArticlesSubsections = cat.id === 'articles';
        const useWriteupSubsections = cat.id === 'writeup' && writeupByPlatform.size > 1;
        return (
          <section class="explorer-section" id={cat.id}>
            <h2 class="explorer-section-title">
              <span class="explorer-section-dot" data-cat={cat.id} aria-hidden="true" />
              {cat.label}
              <span class="explorer-section-count">{count}</span>
            </h2>
            {cat.hint && <p class="explorer-section-hint">{cat.hint}</p>}
            {useArticlesSubsections ? (
              <div class="explorer-subsections">
                {ARTICLES_SUBSECTIONS.map((sub) => {
                  const subItems = byCategory.get(sub.id) ?? [];
                  if (subItems.length === 0) return null;
                  return (
                    <div class="explorer-subsection">
                      <h3 class="explorer-subsection-title">{sub.label}</h3>
                      <ul class="explorer-list">
                        {subItems.map((entry) => (
                          <li>
                            <a href={`/${entry.slug}`} class="explorer-card">
                              <span class="explorer-card-title">{entry.data.title}</span>
                              {entry.data.description && (
                                <span class="explorer-card-desc">{entry.data.description}</span>
                              )}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </div>
                  );
                })}
              </div>
            ) : useWriteupSubsections ? (
              <div class="explorer-subsections">
                {[...writeupByPlatform.entries()].map(([platform, platformDocs]) => (
                  <div class="explorer-subsection">
                    <h3 class="explorer-subsection-title">{platform}</h3>
                    <ul class="explorer-list">
                      {platformDocs.map((entry) => (
                        <li>
                          <a href={`/${entry.slug}`} class="explorer-card">
                            <span class="explorer-card-title">{entry.data.title}</span>
                            {entry.data.description && (
                              <span class="explorer-card-desc">{entry.data.description}</span>
                            )}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                ))}
              </div>
            ) : (
              <ul class="explorer-list">
                {items.map((entry) => {
                  const sub = getSubLabel(entry.id);
                  return (
                    <li>
                      <a href={`/${entry.slug}`} class="explorer-card">
                        <span class="explorer-card-title">{entry.data.title}</span>
                        {entry.data.description && (
                          <span class="explorer-card-desc">{entry.data.description}</span>
                        )}
                        {sub && <span class="explorer-card-badge">{sub}</span>}
                      </a>
                    </li>
                  );
                })}
              </ul>
            )}
          </section>
        );
      })
    }
  </main>

  <footer class="explorer-footer">
    <a href="#" class="explorer-back-top">Retour en haut</a>
  </footer>
</div>

<style>
  .explorer-page {
    --card-bg: rgba(23, 25, 30, 0.6);
    --card-border: var(--sl-color-gray-5);
    --card-hover: var(--sl-color-accent-low);
    max-width: 56rem;
    margin-inline: auto;
    padding-bottom: 2rem;
    scroll-behavior: smooth;
  }
  :global(:root[data-theme="light"]) .explorer-page {
    --card-bg: rgba(255, 255, 255, 0.95);
    --card-border: var(--sl-color-gray-5);
    --card-hover: var(--sl-color-accent-low);
  }

  .explorer-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  .explorer-title {
    font-size: clamp(1.75rem, 4vw, var(--sl-text-4xl));
    font-weight: 700;
    color: var(--sl-color-white);
    margin: 0 0 0.5rem 0;
    line-height: 1.2;
    letter-spacing: -0.02em;
  }
  .explorer-tagline {
    font-size: var(--sl-text-lg);
    color: var(--sl-color-gray-2);
    margin: 0 0 1rem 0;
    max-width: 36ch;
    margin-inline: auto;
  }
  .explorer-stats {
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-3);
  }
  .explorer-stat strong {
    color: var(--sl-color-accent);
    font-weight: 600;
  }
  .explorer-stat-sep {
    margin: 0 0.5rem;
    opacity: 0.6;
  }

  .explorer-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 0.75rem;
    justify-content: center;
    margin-bottom: 2.5rem;
    padding: 1rem 0 1.25rem;
    border-bottom: 1px solid var(--card-border);
    position: sticky;
    top: 0;
    z-index: 2;
    background: var(--sl-color-background);
  }
  .explorer-nav-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.9rem;
    border-radius: 999px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    color: var(--sl-color-gray-2);
    text-decoration: none;
    font-size: var(--sl-text-sm);
    font-weight: 500;
    transition: color 0.15s ease, border-color 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
  }
  .explorer-nav-link:hover {
    color: var(--sl-color-accent-high);
    border-color: var(--sl-color-accent);
    background: var(--card-hover);
  }
  .explorer-nav-link:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }
  .explorer-nav-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background: var(--sl-color-accent);
    flex-shrink: 0;
  }
  .explorer-nav-dot[data-cat="articles"] { background: #ec4899; }
  .explorer-nav-dot[data-cat="writeup"] { background: #22c55e; }
  .explorer-nav-dot[data-cat="events"] { background: #f59e0b; }
  .explorer-nav-dot[data-cat="cybersecurity"] { background: #06b6d4; }
  .explorer-nav-dot[data-cat="misc"] { background: var(--sl-color-gray-4); }
  .explorer-nav-text {
    white-space: nowrap;
  }
  .explorer-nav-count {
    font-size: var(--sl-text-xs);
    opacity: 0.9;
    background: var(--sl-color-gray-5);
    padding: 0.1rem 0.4rem;
    border-radius: 999px;
    margin-left: 0.15rem;
  }
  :global(:root[data-theme="light"]) .explorer-nav-count {
    background: var(--sl-color-gray-6);
  }

  .explorer-sections {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }
  .explorer-section {
    scroll-margin-top: 5rem;
  }
  .explorer-section-title {
    font-size: var(--sl-text-xl);
    font-weight: 600;
    color: var(--sl-color-white);
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .explorer-section-dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    flex-shrink: 0;
    background: var(--sl-color-accent);
  }
  .explorer-section-dot[data-cat="articles"] { background: #ec4899; }
  .explorer-section-dot[data-cat="writeup"] { background: #22c55e; }
  .explorer-section-dot[data-cat="events"] { background: #f59e0b; }
  .explorer-section-dot[data-cat="cybersecurity"] { background: #06b6d4; }
  .explorer-section-dot[data-cat="misc"] { background: var(--sl-color-gray-4); }
  .explorer-section-hint {
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-3);
    margin: -0.5rem 0 1rem 0;
    line-height: 1.45;
    max-width: 42rem;
  }
  .explorer-section-count {
    font-size: var(--sl-text-sm);
    font-weight: 500;
    color: var(--sl-color-gray-3);
    margin-left: 0.25rem;
  }

  .explorer-subsections {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .explorer-subsection-title {
    font-size: var(--sl-text-sm);
    font-weight: 600;
    color: var(--sl-color-accent);
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .explorer-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.65rem;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 18rem), 1fr));
  }
  .explorer-card {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    padding: 1rem 1.2rem;
    border-radius: 0.5rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    text-decoration: none;
    color: inherit;
    transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
  }
  .explorer-card:hover {
    border-color: var(--sl-color-accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    transform: translateY(-1px);
  }
  .explorer-card:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }
  @media (prefers-reduced-motion: reduce) {
    .explorer-card:hover {
      transform: none;
    }
  }
  .explorer-card-title {
    font-weight: 600;
    color: var(--sl-color-white);
    font-size: var(--sl-text-base);
  }
  .explorer-card-desc {
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-2);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .explorer-card-badge {
    font-size: var(--sl-text-xs);
    font-weight: 600;
    color: var(--sl-color-accent);
    margin-top: 0.2rem;
  }

  .explorer-footer {
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--card-border);
    text-align: center;
  }
  .explorer-back-top {
    font-size: var(--sl-text-sm);
    color: var(--sl-color-accent);
    text-decoration: none;
    font-weight: 500;
  }
  .explorer-back-top:hover {
    text-decoration: underline;
  }
  .explorer-back-top:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }
</style>
