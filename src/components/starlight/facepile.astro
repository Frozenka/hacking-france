---
import { Image } from 'astro:assets';
import { cachedFetch } from '../../util-server.ts';

export interface Props {
	tagline: string;
	link: string;
	linkText: string;
}

const { tagline, link, linkText } = Astro.props;

type Contributor = {
	username: string;
	avatar_url: string;
};

const res = await cachedFetch('https://raw.githubusercontent.com/Frozenka/hacking-france/main/src/assets/cards.json');
const allContributors: Contributor[] = (await res.json()).data;

const arrangement = [3, 4, 3, 3, 6, 4, 6, 3, 3, 3];
const circles = [1, 0, 2, 2, -1, 2, -1, -1, 3, -1];
const spaces = [-1, -1, -1, 1, -1, -1, -1, -1, -1];

const contributorArrangement = arrangement.map((i) => allContributors.splice(0, i));
---

<div class="mobile-only not-content">
	<p class="tagline">{tagline} <a href={link}>{linkText}</a></p>
</div>
<div class="facepile not-content">
	{
		contributorArrangement.map((contributors: (Contributor | number)[], i) => {
			if (circles[i] !== -1) contributors.splice(circles[i], 0, 1);
			if (spaces[i] !== -1) contributors.splice(spaces[i], 0, 2);
			return (
				<div class="row">
					{i === 7 && (
						<p class="tagline">
							{tagline} <a href={link}>{linkText}</a>
						</p>
					)}
					{contributors.map((cell) =>
						typeof cell === 'number' ? (
							<span class:list={[cell === 1 && 'circle']} />
						) : (
							<a
								href={`https://github.com/${cell.username}`}
								target="_blank"
								rel="noopener noreferrer"
								title={`Profil GitHub de ${cell.username}`}
								class="facepile-avatar-link"
							>
								<Image
									width="84"
									height="84"
									quality="low"
									loading="eager"
									src={cell.avatar_url}
									alt={cell.username}
								/>
							</a>
						)
					)}
				</div>
			);
		})
	}
</div>

<style>
	.facepile {
		/* Size grid fluidly so on mobile 6 avatars fit in the viewport and size is capped at 56px. */
		--cell-size: min(3.5rem, 13vw);
		--grid-gap: min(1rem, 3vw);

		margin-block: calc(-0.5 * var(--cell-size));
		padding: 0 var(--grid-gap);
		display: flex;
		flex-direction: column;
		align-items: end;
		gap: var(--grid-gap);
		overflow: hidden;
		/* Cap at 6 rows of avatars on mobile. */
		max-height: calc(6 * var(--cell-size) + 5 * var(--grid-gap));
		-webkit-mask-image: linear-gradient(to bottom, transparent, black, transparent);
		mask-image: linear-gradient(to bottom, transparent, black, transparent);
		pointer-events: none;

		background: radial-gradient(closest-side, var(--sl-color-red-low), transparent) no-repeat
			calc(100% + var(--cell-size) * 5) 50% / calc(var(--cell-size) * 8) calc(var(--cell-size) * 15);
	}

	.row {
		display: flex;
		align-items: center;
		gap: var(--grid-gap);
	}

	.row > :not(.tagline) {
		border-radius: 100%;
		width: var(--cell-size);
		height: var(--cell-size);
	}

	.facepile-avatar-link {
		pointer-events: auto;
		display: block;
		border-radius: 100%;
		width: var(--cell-size);
		height: var(--cell-size);
		overflow: hidden;
		flex-shrink: 0;
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}
	.facepile-avatar-link img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
		vertical-align: middle;
	}
	.facepile-avatar-link:hover {
		transform: scale(1.12);
		box-shadow: 0 0 0 2px var(--sl-color-accent);
	}
	@media (prefers-reduced-motion: reduce) {
		.facepile-avatar-link:hover {
			transform: none;
		}
	}

	.circle {
		border: 1px solid var(--sl-color-white);
		opacity: 0.2;
	}

	.tagline {
		color: var(--sl-color-white);
		font-size: var(--sl-text-base);
		font-weight: 500;
		text-wrap: balance;
		pointer-events: all;
		line-height: 1.4;
	}

	.tagline a {
		color: var(--sl-color-text-accent);
		white-space: nowrap;
	}

	.row > .tagline {
		text-align: right;
		max-width: 15rem;
		padding-inline-end: 0.5rem;
		/* Negative vertical margin prevents the tagline forcing the grid row wider if text wraps onto three lines. */
		margin-block: -1rem;
	}

	.mobile-only {
		padding: 1rem 1.25rem;
		text-align: center;
		color: var(--sl-color-white);
		font-size: var(--sl-text-base);
		font-weight: 500;
	}
	.mobile-only .tagline a {
		text-decoration: underline;
		text-underline-offset: 0.2em;
	}

	@media (min-width: 78rem) {
		.mobile-only {
			display: none;
		}
		.facepile {
			display: flex;
			padding: var(--grid-gap);
			margin-block: 0;

			max-height: unset;
			-webkit-mask-image: unset;
			mask-image: unset;
			background: none;
		}
	}
</style>
